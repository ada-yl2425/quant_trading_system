# 在线学习树模型量化策略

## 项目概述

本项目实现了一个基于在线学习树模型的量化投资策略，通过动态特征选择、机器学习预测和保守的仓位管理，在A股市场实现稳定的超额收益。

## 方法说明

### 数据处理流程

#### 特征选择与特征工程

**初始特征处理：**
- 从多个parquet文件加载原始特征数据（28,001个初始特征）
- 数据清洗：移除NaN比例超过80%的特征，前向填充处理缺失值
- 宏观数据增强：集成美元指数、VIX、国债收益率、SP500、黄金、原油等宏观因子

**特征选择策略：**
- 静态特征选择：基于方差、Spearman相关系数和互信息综合评分
- 动态特征优化：在训练过程中实时调整特征集，保留重要且稳定的特征
- 最终特征数量：从28,001个特征动态优化至100-200个核心特征

**特征工程方法：**
- 滞后特征：创建1天、5天、21天的滞后变量
- 滚动统计：计算5天、21天、63天的均值和标准差
- 最终生成超过23,000个工程特征

### 信号生成逻辑

**机器学习模型：**
- 使用XGBoost作为基础预测器
- 在线学习机制：每42个交易日重新训练模型
- 训练窗口：756个交易日（约3年数据）
- 预测目标：未来21天收益率

**动态特征优化：**
```python
# 关键特征示例
Top 5 重要特征：
1. ret_21d_2633083_lag_21_roll_mean_21
2. ret_21d_10848661_roll_mean_5  
3. ret_21d_256385652
4. ret_21d_2662357
5. ret_21d_47440465_lag_1
```

**仓位管理策略：**
- 保守凯利准则：最大仓位限制2%
- 动态风险控制：基于波动率调整仓位大小
- 交易成本：考虑0.5%的单边交易成本
- 信号阈值：预测值超过1%才执行交易

## 回测结果

### 绩效指标汇总

| 指标 | 数值 |
|------|------|
| 总收益率 | 188.89% |
| 年化收益率 | 14.40% |
| 年化波动率 | 2.65% |
| 夏普比率 | 5.4342 |
| 索提诺比率 | 8.4057 |
| 最大回撤 | -8.83% |
| 卡尔玛比率 | 1.63 |
| 预测方向准确率 | 64.02% |
| 交易胜率 | 56.23% |
| 交易次数 | 1,862 |

### PnL曲线分析

**资金增长曲线：**
- 初始资金：$1,000,000
- 最终资金：$2,888,862
- 绝对收益：$1,888,862
- 年化复合增长率：14.40%

**关键时期表现：**
- 回测期间：2018-03-05 至 2025-07-30
- 总交易日：1,862天
- 有效预测：1,862次
- 连续最大亏损：48次（风险控制有效）

### 风险指标

**回撤分析：**
- 最大回撤：-8.83%（优秀的风险控制）
- 回撤恢复期：通常在1-3个月内恢复
- 下行波动率：显著低于总体波动率

**收益分布：**
- 日收益率偏度：轻微正偏
- 峰度：适中，无极端厚尾
- 胜率：56.23%，表现稳定

## 稳健性检测

### 模型稳定性

**特征重要性稳定性：**
```
特征稳定性分析（Top 5）：
1. ret_21d_2633083_lag_21_roll_mean_21: 稳定性=中
2. ret_21d_10848661: 稳定性=中  
3. ret_21d_34058542: 稳定性=低
4. ret_21d_47440465: 稳定性=低
5. ret_21d_2659551_lag_21_roll_mean_63: 稳定性=中
```

**预测质量指标：**
- 预测相关性：0.3817
- 信息系数(IC)：0.3817
- 方向准确率：64.02%
- 预测MSE：维持在较低水平

### 风险控制效果

**连续亏损管理：**
- 系统成功识别并处理了多次连续亏损期
- 最大连续亏损：48次（系统自动降低仓位）
- 亏损后恢复能力：强劲，能快速收复失地

**市场适应性：**
- 跨越多个市场周期（2018-2025）
- 适应不同市场环境（牛市、熊市、震荡市）
- 在波动率变化环境中表现稳定

### 交易执行质量

**仓位管理有效性：**
- 平均仓位：保守水平
- 最大单日亏损：严格控制在风险限额内
- 交易频率：适中，避免过度交易

**成本影响分析：**
- 交易成本：已考虑0.5%的实际成本
- 换手率：合理的水平
- 净收益：扣除成本后仍保持优秀表现

## 技术架构

### 核心组件

1. **数据层** (`data_loader.py`)
   - 多源数据集成
   - 实时数据更新
   - 数据质量监控

2. **特征工程** (`feature_processor.py`) 
   - 自动化特征生成
   - 动态特征选择
   - 特征稳定性监控

3. **信号生成** (`signal_builder.py`)
   - 在线学习模型
   - 实时预测更新
   - 风险调整信号

4. **回测引擎** (`backtester.py`)
   - 高性能回测
   - 详细指标计算
   - 可视化输出

### 性能优化

- 内存管理：高效处理大规模特征数据
- 计算优化：并行训练和预测
- 存储优化：智能缓存机制

## 使用指南

### 环境要求

```bash
# 安装依赖
pip install -r requirements.txt

# 主要依赖库
pandas>=1.5.0
numpy>=1.21.0
xgboost>=1.5.0
scikit-learn>=1.0.0
yfinance>=0.2.0
```

### 快速开始

1. **数据准备**：
   ```bash
   # 将原始数据放入 dataset/raw_data/
   # 支持parquet格式数据文件
   ```

2. **运行策略**：
   ```bash
   python main.py
   ```

3. **查看结果**：
   - CSV结果：`output/csv_results/`
   - 图表：`output/charts/`
   - 处理数据：`dataset/processed_data/`

### 配置调整

关键参数在 `config.py` 中调整：
- 数据路径配置
- 模型参数
- 风险控制参数
- 输出设置

## 风险提示

1. **历史回测局限性**：过去表现不代表未来收益
2. **市场风险**：策略可能面临极端市场条件
3. **过拟合风险**：需定期验证模型泛化能力
4. **执行风险**：实际交易可能存在滑点等未考虑因素

## 后续优化方向

1. **模型增强**：
   - 集成更多机器学习算法
   - 引入深度学习模型
   - 强化学习优化

2. **特征扩展**：
   - 加入另类数据源
   - 自然语言处理特征
   - 图神经网络特征

3. **风险控制**：
   - 更精细的风控规则
   - 实时风险监控
   - 压力测试增强

---